<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tudor Glen Invoice Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background: #f87171;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5em;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .period-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .period-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        canvas {
            max-width: 100%;
        }

        .date-range {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .data-table h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }

        .ai-query {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .ai-query h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 200px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.loading {
            background: #f0f0f0;
            color: #666;
            font-style: italic;
        }

        .query-input-container {
            display: flex;
            gap: 10px;
        }

        .query-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .query-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .send-btn:hover:not(:disabled) {
            background: #5568d3;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Tudor Glen Invoice Dashboard</h1>
            <p>Invoice tracking and analytics for the past 365 days</p>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="connectionStatus"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
                <div class="status-item">
                    <span>Last Update: <span id="lastUpdate">Never</span></span>
                </div>
            </div>
        </div>

        <div class="ai-query">
            <h2>ü§ñ AI Query Assistant</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <strong>AI Assistant:</strong> Hello! I can help you query and analyze your invoice data. Ask me anything!
                    </div>
                </div>
                <div class="query-input-container">
                    <input 
                        type="text" 
                        id="queryInput" 
                        class="query-input" 
                        placeholder="Ask a question about your invoice data..."
                        onkeypress="if(event.key === 'Enter') { console.log('üî¥ Enter key pressed'); sendQuery(); }"
                    >
                    <button class="send-btn" id="sendBtn" onclick="console.log('üî¥ Send button clicked'); sendQuery();">Send</button>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2><span class="card-icon">üìà</span> Total Invoices</h2>
                <div class="stat-value" id="totalInvoices">-</div>
                <div class="stat-label" id="totalInvoicesLabel">Invoices in the past year</div>
            </div>
            <div class="card">
                <h2><span class="card-icon">üí∞</span> Total Revenue</h2>
                <div class="stat-value" id="totalRevenue">-</div>
                <div class="stat-label" id="totalRevenueLabel">Revenue in the past year</div>
            </div>
            <div class="card">
                <h2><span class="card-icon">üìä</span> Avg Per Day</h2>
                <div class="stat-value" id="avgPerDay">-</div>
                <div class="stat-label">Average invoices per day</div>
            </div>
            <div class="card">
                <h2><span class="card-icon">üìÖ</span> Avg Per Weekday</h2>
                <div class="stat-value" id="avgPerWeekday">-</div>
                <div class="stat-label">Average invoices per weekday</div>
            </div>
            <div class="card">
                <h2><span class="card-icon">üóìÔ∏è</span> Avg Per Saturday</h2>
                <div class="stat-value" id="avgPerSaturday">-</div>
                <div class="stat-label">Average invoices per Saturday</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üìà Invoices by Date</h2>
            <div class="period-filters">
                <button class="period-btn" data-period="week" onclick="filterByPeriod('week')">Last Week</button>
                <button class="period-btn" data-period="month" onclick="filterByPeriod('month')">Last Month</button>
                <button class="period-btn active" data-period="year" onclick="filterByPeriod('year')">Last Year</button>
            </div>
            <div class="date-range" id="dateRange"></div>
            <div class="chart-wrapper">
                <canvas id="invoiceChart"></canvas>
            </div>
        </div>

        <div class="data-table">
            <h2>üìã Invoice Data by Date</h2>
            <div id="dataContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading invoice data...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let refreshIntervalId = null;
        
        // Detect if running from file://, http://localhost, or GitHub Pages
        const isFileProtocol = window.location.protocol === 'file:';
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isGitHubPages = window.location.hostname.includes('github.io');
        
        // Use proxy endpoints if running on local server, otherwise use direct URLs
        const invoiceDataWebhookUrl = (isFileProtocol || isGitHubPages)
            ? 'https://jackwilde.app.n8n.cloud/webhook/60e42850-6593-4d18-a4c7-c38293d1d768'
            : '/proxy/invoice';
        const aiWebhookUrl = (isFileProtocol || isGitHubPages)
            ? 'https://jackwilde.app.n8n.cloud/webhook/dfd8f0c4-c739-4c8b-a772-48c2040cfc83'
            : '/proxy/ai';
            
        let invoiceChart = null;
        let fullInvoiceData = null; // Store all data
        let currentPeriod = 'year'; // Default period

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set up auto-refresh for invoice data
            setupAutoRefresh();

            // Initial fetch on page load
            fetchData();
        });

        function setupAutoRefresh() {
            // Clear existing interval
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
            }

            // Auto-refresh every 30 seconds
            refreshIntervalId = setInterval(fetchData, 30000);
        }

        async function fetchData() {
            updateConnectionStatus(true, 'connecting');
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading invoice data...</p></div>';

            try {
                const response = await fetch(invoiceDataWebhookUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Data received from webhook:', data);
                displayData(data);
                updateConnectionStatus(true, 'connected');
                updateLastUpdate();
            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus(false);
                
                let errorMessage = error.message;
                let errorDetails = '';
                
                // Check for CORS errors
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch') || 
                    error.message.includes('Access-Control-Allow-Origin')) {
                    errorMessage = 'CORS Error: Cannot fetch data from webhook';
                    errorDetails = `
                        <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                            <strong>‚ö†Ô∏è CORS Policy Error</strong>
                            <p style="margin: 10px 0;">This error occurs when opening the HTML file directly from your computer. 
                            You need to run a local web server instead.</p>
                            <p style="margin: 10px 0;"><strong>Solution:</strong></p>
                            <ol style="margin-left: 20px; margin-top: 10px;">
                                <li>Open Terminal</li>
                                <li>Navigate to this folder: <code>cd "Tudor Glen - Dev server"</code></li>
                                <li>Run: <code>python3 server.py</code></li>
                                <li>Open <code>http://localhost:8000</code> in your browser</li>
                            </ol>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                See README.md for more options (Node.js, PHP, etc.)
                            </p>
                        </div>
                    `;
                } else {
                    errorDetails = `<br><small>Make sure the webhook URL is correct and accessible.</small>`;
                }
                
                dataContent.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${errorMessage}
                        ${errorDetails}
                    </div>
                `;
            }
        }

        function displayData(data) {
            console.log('displayData called with:', data);
            
            try {
                // Process invoice data
                const invoiceData = processInvoiceData(data);
                console.log('Processed invoice data:', invoiceData);
                
                // Store full data for filtering
                fullInvoiceData = invoiceData;
                
                // Display data for current period
                updateDisplayForPeriod(currentPeriod);
            } catch (error) {
                console.error('Error displaying data:', error);
                const dataContent = document.getElementById('dataContent');
                dataContent.innerHTML = `
                    <div class="error-message">
                        <strong>Error processing data:</strong> ${error.message}
                        <br><br>
                        <strong>Raw data received:</strong>
                        <pre style="background: white; padding: 15px; border-radius: 8px; overflow-x: auto; margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            }
        }

        function filterByPeriod(period) {
            currentPeriod = period;
            
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Update display
            if (fullInvoiceData) {
                updateDisplayForPeriod(period);
            }
        }

        function updateDisplayForPeriod(period) {
            if (!fullInvoiceData) return;
            
            // Calculate date range for selected period
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            const startDate = new Date(endDate);
            
            let periodLabel = '';
            switch(period) {
                case 'week':
                    startDate.setDate(startDate.getDate() - 6); // Last 7 days
                    periodLabel = 'Last 7 Days';
                    break;
                case 'month':
                    startDate.setMonth(startDate.getMonth() - 1); // Last month
                    periodLabel = 'Last Month';
                    break;
                case 'year':
                    startDate.setDate(startDate.getDate() - 364); // Last 365 days
                    periodLabel = 'Last Year';
                    break;
            }
            startDate.setHours(0, 0, 0, 0);
            
            // Filter daily data
            const filteredData = fullInvoiceData.dailyData.filter(item => {
                return item.date >= startDate && item.date <= endDate;
            });
            
            // Calculate statistics for filtered period
            const totalInvoices = filteredData.reduce((sum, item) => sum + item.count, 0);
            const totalRevenue = filteredData.reduce((sum, item) => sum + (item.revenue || 0), 0);
            
            // Count days in period
            const daysInPeriod = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const avgPerDay = daysInPeriod > 0 ? totalInvoices / daysInPeriod : 0;
            
            // Calculate weekday and Saturday averages
            const weekdayData = filteredData.filter(item => {
                const dayOfWeek = item.date.getDay();
                return dayOfWeek >= 1 && dayOfWeek <= 5;
            });
            const saturdayData = filteredData.filter(item => item.date.getDay() === 6);
            
            const weekdayInvoices = weekdayData.reduce((sum, item) => sum + item.count, 0);
            const saturdayInvoices = saturdayData.reduce((sum, item) => sum + item.count, 0);
            
            const weekdayDays = weekdayData.length;
            const saturdayDays = saturdayData.length;
            
            const avgPerWeekday = weekdayDays > 0 ? weekdayInvoices / weekdayDays : 0;
            const avgPerSaturday = saturdayDays > 0 ? saturdayInvoices / saturdayDays : 0;
            
            // Update statistics cards
            updateStat('totalInvoices', totalInvoices.toLocaleString());
            if (totalRevenue > 0) {
                updateStat('totalRevenue', '$' + totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
            } else {
                updateStat('totalRevenue', '-');
            }
            updateStat('avgPerDay', avgPerDay.toFixed(2));
            updateStat('avgPerWeekday', avgPerWeekday.toFixed(2));
            updateStat('avgPerSaturday', avgPerSaturday.toFixed(2));
            
            // Update card labels
            const totalInvoicesLabel = document.getElementById('totalInvoicesLabel');
            const totalRevenueLabel = document.getElementById('totalRevenueLabel');
            if (totalInvoicesLabel) {
                totalInvoicesLabel.textContent = `Invoices in ${periodLabel.toLowerCase()}`;
            }
            if (totalRevenueLabel) {
                totalRevenueLabel.textContent = `Revenue in ${periodLabel.toLowerCase()}`;
            }
            
            // Update date range display
            const dateRangeEl = document.getElementById('dateRange');
            dateRangeEl.textContent = `${periodLabel}: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
            
            // Update chart
            if (filteredData.length > 0) {
                updateChart(filteredData);
            } else {
                showChartMessage('No data available for the selected period.');
            }
            
            // Display detailed data table
            if (filteredData.length > 0) {
                displayInvoiceTable(filteredData);
            } else {
                const dataContent = document.getElementById('dataContent');
                dataContent.innerHTML = '<div class="error-message">No invoice data found for the selected period.</div>';
            }
        }

        function processInvoiceData(data) {
            // Calculate date range (last 365 days)
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 364);
            startDate.setHours(0, 0, 0, 0);

            console.log('Processing data, type:', typeof data, 'isArray:', Array.isArray(data));
            
            // Check if data is in daily format (txn_day, invoices, revenue)
            if (Array.isArray(data) && data.length > 0 && data[0].txn_day !== undefined && data[0].invoices !== undefined) {
                console.log('Processing daily data format with', data.length, 'records');
                return processDailyDataFormat(data, startDate, endDate);
            }

            // Check if data is in aggregated format (from webhook)
            let stats = null;
            if (Array.isArray(data) && data.length > 0) {
                console.log('Data is array, first element:', data[0]);
                if (data[0].total_number_of_invoices !== undefined) {
                    // Webhook returns aggregated stats in array
                    stats = data[0];
                }
            } else if (data && typeof data === 'object' && data.total_number_of_invoices !== undefined) {
                // Single object with stats
                stats = data;
            }

            if (stats) {
                // Use aggregated statistics from webhook
                const totalInvoices = stats.total_number_of_invoices || 0;
                const avgPerDay = stats.average_invoices_per_date || 0;
                const avgPerWeekday = stats.average_weekday_invoices || 0;
                const avgPerSaturday = stats.average_saturday_invoices || 0;
                
                const dailyData = [];

                return {
                    totalInvoices,
                    totalRevenue: 0,
                    avgPerDay,
                    avgPerWeekday,
                    avgPerSaturday,
                    dailyData,
                    startDate,
                    endDate,
                    hasDailyData: false,
                    stats: stats
                };
            }

            // Fallback: Try to process individual invoice records
            return processIndividualRecords(data, startDate, endDate);
        }

        function processDailyDataFormat(data, startDate, endDate) {
            // Create a map for all dates in range, initialized with 0
            const dailyDataMap = new Map();
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = formatDateKey(d);
                dailyDataMap.set(dateKey, {
                    date: new Date(d),
                    count: 0,
                    revenue: 0
                });
            }

            let totalInvoices = 0;
            let totalRevenue = 0;
            let weekdayInvoices = 0;
            let weekdayRevenue = 0;
            let weekdayDays = 0;
            let saturdayInvoices = 0;
            let saturdayRevenue = 0;
            let saturdayDays = 0;

            // Process each daily record
            data.forEach(record => {
                const recordDate = new Date(record.txn_day);
                if (isNaN(recordDate.getTime())) {
                    return; // Skip invalid dates
                }

                const dateKey = formatDateKey(recordDate);
                if (dailyDataMap.has(dateKey)) {
                    const dayData = dailyDataMap.get(dateKey);
                    dayData.count = record.invoices || 0;
                    dayData.revenue = record.revenue || 0;
                    totalInvoices += dayData.count;
                    totalRevenue += dayData.revenue;

                    // Track weekday vs Saturday
                    const dayOfWeek = recordDate.getDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                        weekdayInvoices += dayData.count;
                        weekdayRevenue += dayData.revenue;
                    } else if (dayOfWeek === 6) { // Saturday
                        saturdayInvoices += dayData.count;
                        saturdayRevenue += dayData.revenue;
                    }
                }
            });

            // Count weekday and Saturday days in range
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    weekdayDays++;
                } else if (dayOfWeek === 6) {
                    saturdayDays++;
                }
            }

            // Convert to sorted array
            const dailyData = Array.from(dailyDataMap.values())
                .sort((a, b) => a.date - b.date);

            // Calculate averages
            const totalDays = 365;
            const avgPerDay = totalInvoices / totalDays;
            const avgPerWeekday = weekdayDays > 0 ? weekdayInvoices / weekdayDays : 0;
            const avgPerSaturday = saturdayDays > 0 ? saturdayInvoices / saturdayDays : 0;

            return {
                totalInvoices,
                totalRevenue,
                avgPerDay,
                avgPerWeekday,
                avgPerSaturday,
                dailyData,
                startDate,
                endDate,
                hasDailyData: true
            };
        }

        function processIndividualRecords(data, startDate, endDate) {
            let records = [];
            
            if (Array.isArray(data)) {
                records = data;
            } else if (data.invoices) {
                records = Array.isArray(data.invoices) ? data.invoices : [data.invoices];
            } else if (data.records) {
                records = data.records;
            } else if (data.data) {
                records = Array.isArray(data.data) ? data.data : [data.data];
            }

            // Group invoices by date
            const dailyCounts = new Map();
            let totalInvoices = 0;
            let weekdayInvoices = 0;
            let weekdayDays = 0;
            let saturdayInvoices = 0;
            let saturdayDays = 0;

            // Initialize all dates in range with 0
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = formatDateKey(d);
                dailyCounts.set(dateKey, 0);
            }

            // Process records
            records.forEach(record => {
                let recordDate = null;
                
                // Try to extract date from various possible fields
                if (record.date) {
                    recordDate = new Date(record.date);
                } else if (record.createdDate) {
                    recordDate = new Date(record.createdDate);
                } else if (record.created_at) {
                    recordDate = new Date(record.created_at);
                } else if (record.invoiceDate) {
                    recordDate = new Date(record.invoiceDate);
                } else if (record.txn_day) {
                    recordDate = new Date(record.txn_day);
                } else if (typeof record === 'string' && record.match(/^\d{4}-\d{2}-\d{2}/)) {
                    recordDate = new Date(record);
                }

                if (recordDate && !isNaN(recordDate.getTime())) {
                    // Check if date is within last 365 days
                    if (recordDate >= startDate && recordDate <= endDate) {
                        const dateKey = formatDateKey(recordDate);
                        const currentCount = dailyCounts.get(dateKey) || 0;
                        dailyCounts.set(dateKey, currentCount + 1);
                        totalInvoices++;

                        // Track weekday vs Saturday
                        const dayOfWeek = recordDate.getDay();
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                            weekdayInvoices++;
                        } else if (dayOfWeek === 6) { // Saturday
                            saturdayInvoices++;
                        }
                    }
                }
            });

            // Count weekday and Saturday days in range
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    weekdayDays++;
                } else if (dayOfWeek === 6) {
                    saturdayDays++;
                }
            }

            // Convert daily counts to sorted array
            const dailyData = Array.from(dailyCounts.entries())
                .map(([date, count]) => ({
                    date: new Date(date),
                    count: count,
                    revenue: 0
                }))
                .sort((a, b) => a.date - b.date);

            // Calculate averages
            const totalDays = 365;
            const avgPerDay = totalInvoices / totalDays;
            const avgPerWeekday = weekdayDays > 0 ? weekdayInvoices / weekdayDays : 0;
            const avgPerSaturday = saturdayDays > 0 ? saturdayInvoices / saturdayDays : 0;

            return {
                totalInvoices,
                totalRevenue: 0,
                avgPerDay,
                avgPerWeekday,
                avgPerSaturday,
                dailyData,
                startDate,
                endDate,
                hasDailyData: true
            };
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function updateChart(dailyData) {
            const ctx = document.getElementById('invoiceChart').getContext('2d');
            
            const labels = dailyData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const counts = dailyData.map(d => d.count);
            const hasRevenue = dailyData.some(d => d.revenue !== undefined && d.revenue > 0);
            const revenues = hasRevenue ? dailyData.map(d => d.revenue || 0) : null;

            if (invoiceChart) {
                invoiceChart.destroy();
            }

            const datasets = [{
                label: 'Invoices',
                data: counts,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 5,
                yAxisID: 'y'
            }];

            // Add revenue dataset if available
            if (hasRevenue && revenues) {
                datasets.push({
                    label: 'Revenue',
                    data: revenues,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    yAxisID: 'y1'
                });
            }

            invoiceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: hasRevenue,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return dailyData[context[0].dataIndex].date.toLocaleDateString('en-US', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    if (context.dataset.label === 'Revenue') {
                                        return `Revenue: $${context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                    }
                                    return `Invoices: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Invoices'
                            }
                        },
                        y1: hasRevenue ? {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Revenue ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        } : undefined,
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 30
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        function showChartMessage(message) {
            // Destroy existing chart if it exists
            if (invoiceChart) {
                invoiceChart.destroy();
                invoiceChart = null;
            }
            
            const chartWrapper = document.querySelector('.chart-wrapper');
            chartWrapper.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border-radius: 8px; padding: 40px;">
                    <div style="text-align: center; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìä</div>
                        <p style="font-size: 1.1em;">${message}</p>
                    </div>
                </div>
            `;
        }

        function displayInvoiceTable(dailyData) {
            const dataContent = document.getElementById('dataContent');
            
            if (dailyData.length === 0) {
                dataContent.innerHTML = '<div class="error-message">No invoice data found for the last 365 days.</div>';
                return;
            }

            // Check if revenue data is available
            const hasRevenue = dailyData.some(item => item.revenue !== undefined && item.revenue > 0);
            
            let tableHTML = '<table><thead><tr><th>Date</th><th>Day of Week</th><th>Number of Invoices</th>';
            if (hasRevenue) {
                tableHTML += '<th>Revenue</th>';
            }
            tableHTML += '</tr></thead><tbody>';
            
            dailyData.forEach(item => {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[item.date.getDay()];
                const dateStr = item.date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                tableHTML += `<tr>
                    <td>${dateStr}</td>
                    <td>${dayName}</td>
                    <td><strong>${item.count}</strong></td>`;
                
                if (hasRevenue) {
                    const revenue = item.revenue || 0;
                    tableHTML += `<td>$${revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
                }
                
                tableHTML += `</tr>`;
            });

            tableHTML += '</tbody></table>';
            dataContent.innerHTML = tableHTML;
        }

        function displaySummaryTable(invoiceData) {
            const dataContent = document.getElementById('dataContent');
            const stats = invoiceData.stats || {};
            
            let tableHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">Summary Statistics</h3>
                    <p style="color: #666; margin-bottom: 15px;">The webhook provides aggregated statistics. Individual daily breakdown is not available.</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Total Number of Invoices</strong></td>
                            <td><strong>${stats.total_number_of_invoices?.toLocaleString() || invoiceData.totalInvoices.toLocaleString()}</strong></td>
                        </tr>
                        <tr>
                            <td>Total Dates with Invoices</td>
                            <td>${stats.total_dates || '-'}</td>
                        </tr>
                        <tr>
                            <td>Average Invoices Per Date</td>
                            <td>${stats.average_invoices_per_date?.toFixed(2) || invoiceData.avgPerDay.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Weekday Total Invoices</td>
                            <td>${stats.weekday_total_invoices?.toLocaleString() || '-'}</td>
                        </tr>
                        <tr>
                            <td>Weekday Dates</td>
                            <td>${stats.weekday_dates || '-'}</td>
                        </tr>
                        <tr>
                            <td>Average Weekday Invoices</td>
                            <td>${stats.average_weekday_invoices?.toFixed(2) || invoiceData.avgPerWeekday.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Saturday Total Invoices</td>
                            <td>${stats.saturday_total_invoices?.toLocaleString() || '-'}</td>
                        </tr>
                        <tr>
                            <td>Saturday Dates</td>
                            <td>${stats.saturday_dates || '-'}</td>
                        </tr>
                        <tr>
                            <td>Average Saturday Invoices</td>
                            <td>${stats.average_saturday_invoices?.toFixed(2) || invoiceData.avgPerSaturday.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            dataContent.innerHTML = tableHTML;
        }

        function updateStat(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function updateConnectionStatus(connected, state = 'connected') {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected && state === 'connected') {
                indicator.className = 'status-indicator';
                text.textContent = 'Connected';
            } else if (connected && state === 'connecting') {
                indicator.className = 'status-indicator';
                text.textContent = 'Connecting...';
            } else {
                indicator.className = 'status-indicator error';
                text.textContent = 'Disconnected';
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        async function sendQuery() {
            const startTime = performance.now();
            console.group('üöÄ sendQuery() - START');
            console.log('Timestamp:', new Date().toISOString());
            console.log('Performance mark:', startTime);
            
            const queryInput = document.getElementById('queryInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chatMessages');
            
            console.log('üìã DOM Elements:', {
                queryInput: !!queryInput,
                sendBtn: !!sendBtn,
                chatMessages: !!chatMessages
            });
            
            const query = queryInput.value.trim();
            console.log('üìù Query Details:', {
                rawValue: queryInput.value,
                trimmedValue: query,
                length: query.length,
                isEmpty: !query
            });

            console.log('üåê Environment:', {
                isFileProtocol: isFileProtocol,
                protocol: window.location.protocol,
                hostname: window.location.hostname,
                port: window.location.port,
                href: window.location.href
            });

            console.log('üíæ Data State:', {
                fullInvoiceDataAvailable: !!fullInvoiceData,
                fullInvoiceDataType: typeof fullInvoiceData,
                currentPeriod: currentPeriod,
                aiWebhookUrl: aiWebhookUrl,
                invoiceDataWebhookUrl: invoiceDataWebhookUrl
            });

            if (fullInvoiceData) {
                console.log('üìä Invoice Data Details:', {
                    totalInvoices: fullInvoiceData.totalInvoices,
                    totalRevenue: fullInvoiceData.totalRevenue,
                    avgPerDay: fullInvoiceData.avgPerDay,
                    avgPerWeekday: fullInvoiceData.avgPerWeekday,
                    avgPerSaturday: fullInvoiceData.avgPerSaturday,
                    dailyDataLength: fullInvoiceData.dailyData?.length || 0,
                    hasDailyData: fullInvoiceData.hasDailyData,
                    startDate: fullInvoiceData.startDate,
                    endDate: fullInvoiceData.endDate
                });
            }

            if (!query) {
                console.warn('‚ùå No query provided, returning early');
                console.groupEnd();
                return;
            }

            // Disable input while processing
            queryInput.disabled = true;
            sendBtn.disabled = true;
            console.log('üîí Input disabled');

            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.textContent = query;
            chatMessages.appendChild(userMessage);

            // Clear input
            queryInput.value = '';

            // Add loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message ai loading';
            loadingMessage.id = 'loadingMessage';
            loadingMessage.textContent = 'AI is thinking...';
            chatMessages.appendChild(loadingMessage);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Check if we're opening as file - show clear message
            console.log('üîç Checking file protocol...');
            console.log('File protocol check result:', {
                isFileProtocol: isFileProtocol,
                windowLocationProtocol: window.location.protocol,
                willBlock: isFileProtocol
            });
            
            if (isFileProtocol) {
                console.warn('‚ö†Ô∏è File protocol detected - blocking request');
                console.log('Blocking reason: Browser security restriction prevents external requests from file:// protocol');
                loadingMessage.remove();
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai';
                errorMessage.innerHTML = `
                    <strong>AI Assistant:</strong> Cannot connect when opening file directly.
                    <br><br>
                    <strong>‚ö†Ô∏è Browser Security Restriction:</strong> Opening HTML files directly (file://) blocks all external web requests for security reasons.
                    <br><br>
                    <strong>‚úÖ Solution - Use Local Server:</strong>
                    <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li>Open <strong>Terminal</strong> (or Command Prompt)</li>
                        <li>Run: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">cd "Tudor Glen - Dev server"</code></li>
                        <li>Run: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">python3 server.py</code></li>
                        <li>Your browser will open automatically to <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">http://localhost:8000</code></li>
                    </ol>
                    <p style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <strong>üí° Tip:</strong> The server will stay running until you press Ctrl+C. Keep the terminal window open while using the dashboard.
                    </p>
                `;
                chatMessages.appendChild(errorMessage);
                queryInput.disabled = false;
                sendBtn.disabled = false;
                queryInput.focus();
                chatMessages.scrollTop = chatMessages.scrollHeight;
                console.groupEnd();
                return;
            }
            
            console.log('‚úÖ File protocol check passed, proceeding with request');
            
            try {
                console.group('üì¶ Preparing Request Data');
                const dataPrepStart = performance.now();
                
                // Prepare query parameters for GET request
                // Include all invoice data in the request
                const invoiceDataPayload = fullInvoiceData ? {
                    totalInvoices: fullInvoiceData.totalInvoices,
                    totalRevenue: fullInvoiceData.totalRevenue,
                    avgPerDay: fullInvoiceData.avgPerDay,
                    avgPerWeekday: fullInvoiceData.avgPerWeekday,
                    avgPerSaturday: fullInvoiceData.avgPerSaturday,
                    dailyData: fullInvoiceData.dailyData,
                    currentPeriod: currentPeriod
                } : null;
                
                console.log('Invoice Data Payload:', {
                    exists: !!invoiceDataPayload,
                    keys: invoiceDataPayload ? Object.keys(invoiceDataPayload) : [],
                    dailyDataCount: invoiceDataPayload?.dailyData?.length || 0,
                    dailyDataSize: invoiceDataPayload?.dailyData ? 
                        JSON.stringify(invoiceDataPayload.dailyData).length + ' bytes' : 'N/A'
                });
                
                const requestData = {
                    query: query,
                    timestamp: new Date().toISOString(),
                    invoiceData: invoiceDataPayload
                };
                
                const requestDataString = JSON.stringify(requestData);
                const requestDataSize = new Blob([requestDataString]).size;
                
                console.log('Request Data Object:', {
                    query: requestData.query,
                    timestamp: requestData.timestamp,
                    hasInvoiceData: !!requestData.invoiceData,
                    invoiceDataKeys: requestData.invoiceData ? Object.keys(requestData.invoiceData) : [],
                    jsonString: requestDataString.substring(0, 200) + (requestDataString.length > 200 ? '...' : ''),
                    jsonSize: requestDataSize + ' bytes',
                    jsonLength: requestDataString.length + ' characters'
                });
                
                console.log('‚è±Ô∏è Data preparation time:', (performance.now() - dataPrepStart).toFixed(2) + 'ms');
                console.groupEnd();
                
                console.group('üîó Building Request URL');
                const urlBuildStart = performance.now();
                
                // Encode the data as JSON in the query parameter
                const params = new URLSearchParams({
                    data: requestDataString
                });
                
                const paramsString = params.toString();
                console.log('URL Parameters:', {
                    paramString: paramsString.substring(0, 200) + (paramsString.length > 200 ? '...' : ''),
                    paramLength: paramsString.length + ' characters',
                    paramSize: new Blob([paramsString]).size + ' bytes'
                });
                
                // Build URL with query parameters (using server proxy)
                const url = aiWebhookUrl + (aiWebhookUrl.includes('?') ? '&' : '?') + paramsString;
                
                console.log('Final URL Details:', {
                    baseUrl: aiWebhookUrl,
                    fullUrl: url.substring(0, 300) + (url.length > 300 ? '...' : ''),
                    urlLength: url.length + ' characters',
                    urlSize: new Blob([url]).size + ' bytes',
                    hasQueryParams: url.includes('?'),
                    queryParamCount: (url.match(/[&?]/g) || []).length
                });
                
                // Check URL length limits (browsers typically limit to ~2000 chars for GET)
                if (url.length > 2000) {
                    console.warn('‚ö†Ô∏è URL length exceeds 2000 characters - may cause issues with some servers');
                    console.warn('Consider using POST instead of GET for large payloads');
                }
                
                console.log('‚è±Ô∏è URL building time:', (performance.now() - urlBuildStart).toFixed(2) + 'ms');
                console.groupEnd();
                
                console.group('üåê Sending Fetch Request');
                const fetchStart = performance.now();
                console.log('Fetch Configuration:', {
                    method: 'GET',
                    url: url.substring(0, 200) + '...',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('‚è≥ Initiating fetch request...');
                const fetchPromise = fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Fetch promise created, awaiting response...');
                const response = await fetchPromise;
                
                const fetchDuration = performance.now() - fetchStart;
                const totalDuration = performance.now() - startTime;
                
                console.log('‚è±Ô∏è Fetch timing:', {
                    fetchDuration: fetchDuration.toFixed(2) + 'ms',
                    totalDuration: totalDuration.toFixed(2) + 'ms'
                });
                
                console.groupEnd();
                
                console.group('üì• Processing Response');
                console.log('Response Details:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    type: response.type,
                    url: response.url,
                    redirected: response.redirected
                });
                
                const responseHeaders = Object.fromEntries(response.headers.entries());
                console.log('Response Headers:', responseHeaders);
                console.log('Response Header Count:', Object.keys(responseHeaders).length);

                if (!response.ok) {
                    console.error('‚ùå ERROR RESPONSE');
                    console.error('Response Status:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });
                    
                    const errorText = await response.text();
                    console.error('Error Response Body:', {
                        text: errorText,
                        length: errorText.length,
                        isJSON: (() => {
                            try {
                                JSON.parse(errorText);
                                return true;
                            } catch {
                                return false;
                            }
                        })()
                    });
                    
                    console.groupEnd();
                    console.groupEnd();
                    throw new Error(`HTTP error! status: ${response.status}: ${errorText}`);
                }

                console.log('‚úÖ Response OK, parsing JSON...');
                const parseStart = performance.now();
                
                let data;
                try {
                    const responseText = await response.text();
                    console.log('Raw Response Text:', {
                        text: responseText.substring(0, 500) + (responseText.length > 500 ? '...' : ''),
                        length: responseText.length + ' characters',
                        size: new Blob([responseText]).size + ' bytes'
                    });
                    
                    data = JSON.parse(responseText);
                    console.log('‚è±Ô∏è JSON parse time:', (performance.now() - parseStart).toFixed(2) + 'ms');
                } catch (parseError) {
                    console.error('‚ùå JSON Parse Error:', {
                        error: parseError.message,
                        stack: parseError.stack
                    });
                    throw parseError;
                }
                
                console.log('üì• Parsed Response Data:', {
                    type: typeof data,
                    isArray: Array.isArray(data),
                    keys: typeof data === 'object' && data !== null ? Object.keys(data) : 'N/A',
                    data: data
                });
                
                console.log('‚è±Ô∏è Total processing time:', (performance.now() - startTime).toFixed(2) + 'ms');
                console.groupEnd();
                console.groupEnd();
                
                // Remove loading message
                loadingMessage.remove();

                // Add AI response
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai';
                
                // Handle different response formats
                let responseText = '';
                if (typeof data === 'string') {
                    responseText = data;
                } else if (data.response) {
                    responseText = data.response;
                } else if (data.message) {
                    responseText = data.message;
                } else if (data.text) {
                    responseText = data.text;
                } else if (data.error) {
                    responseText = `Error: ${data.error}`;
                } else {
                    responseText = JSON.stringify(data, null, 2);
                }

                aiMessage.innerHTML = `<strong>AI Assistant:</strong> ${responseText}`;
                chatMessages.appendChild(aiMessage);

            } catch (error) {
                const errorTime = performance.now() - startTime;
                console.group('‚ùå ERROR CAUGHT');
                console.error('Error Type:', error.constructor.name);
                console.error('Error Message:', error.message);
                console.error('Error Stack:', error.stack);
                console.error('Error occurred after:', errorTime.toFixed(2) + 'ms');
                console.error('Full Error Object:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    console.error('üîç Fetch Error Analysis:', {
                        possibleCauses: [
                            'Network connectivity issue',
                            'CORS policy blocking request',
                            'Server not running',
                            'Invalid URL',
                            'SSL/TLS certificate issue'
                        ],
                        url: url,
                        isFileProtocol: isFileProtocol
                    });
                }
                
                if (error.name === 'SyntaxError') {
                    console.error('üîç JSON Parse Error - Response might not be valid JSON');
                }
                
                console.groupEnd();
                console.groupEnd(); // Close main group
                
                // Remove loading message
                loadingMessage.remove();

                // Add error message
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai';
                
                let errorText = '';
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch') || 
                    error.message.includes('Access-Control-Allow-Origin') || error.message.includes('NetworkError')) {
                    errorText = `
                        <strong>AI Assistant:</strong> Connection Error - Cannot reach AI webhook.
                        <br><br>
                        <strong>‚ö†Ô∏è Possible Issues:</strong>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Are you running the local server? (Check terminal for "Dashboard server running!")</li>
                            <li>Are you accessing via <code>http://localhost:8000</code>?</li>
                            <li>Is the server still running? (Check terminal window)</li>
                        </ul>
                        <br>
                        <strong>‚úÖ Solution:</strong>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>Open Terminal</li>
                            <li>Run: <code>cd "Tudor Glen - Dev server"</code></li>
                            <li>Run: <code>python3 server.py</code></li>
                            <li>Make sure you see "Dashboard server running!" message</li>
                            <li>Open <code>http://localhost:8000</code> in your browser</li>
                        </ol>
                    `;
                } else {
                    errorText = `
                        <strong>AI Assistant:</strong> Error: ${error.message}
                        <br><br>
                        <strong>Debug Info:</strong> Check browser console (F12) for more details.
                        <br><br>
                        <strong>If using server:</strong> Check terminal for error messages.
                    `;
                }
                
                errorMessage.innerHTML = errorText;
                chatMessages.appendChild(errorMessage);
            } finally {
                // Re-enable input
                queryInput.disabled = false;
                sendBtn.disabled = false;
                queryInput.focus();

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    </script>
</body>
</html>
