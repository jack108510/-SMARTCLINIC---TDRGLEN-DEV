<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tudor Glen Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 10px 40px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-content h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }

        .header-content p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 12px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .nav-tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Page Containers */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px var(--shadow);
            border-color: var(--primary);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .kpi-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            font-size: 1.5rem;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .kpi-comparisons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }

        .comparison-label {
            color: var(--text-secondary);
        }

        .comparison-value {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .comparison-value.positive {
            color: var(--success);
        }

        .comparison-value.negative {
            color: var(--danger);
        }

        .comparison-value.neutral {
            color: var(--text-secondary);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .chart-controls {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .radio-option:hover, .checkbox-option:hover {
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .radio-option input[type="radio"],
        .checkbox-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Analytics Grid */
        .section-container {
            margin-bottom: 48px;
        }

        .section-header {
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .chart-card {
            transition: all 0.3s;
        }

        .chart-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        .analytics-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .analytics-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .analytics-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .analytics-chart {
            height: 300px;
            position: relative;
            flex: 1;
            min-height: 250px;
        }

        /* Settings Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input[readonly] {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .header {
                padding: 24px;
            }

            .header-content h1 {
                font-size: 2rem;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>üìä Tudor Glen Financial Dashboard</h1>
                <p>Real-time financial analytics and insights</p>
            </div>
            <div class="header-actions">
                <div class="status-badge">
                    <div class="status-dot" id="connectionStatus"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
                <button class="btn btn-primary" onclick="openSettings()">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('dashboard', this)">üìä Dashboard</button>
            <button class="nav-tab" onclick="showPage('charts', this)">üìà Charts & Analytics</button>
            <button class="nav-tab" onclick="showPage('tools', this)">üõ†Ô∏è Tools</button>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <!-- Financial KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Total Revenue</span>
                    <span class="kpi-icon">üí∞</span>
                </div>
                <div class="kpi-value" id="kpiRevenue">-</div>
                <div class="kpi-label">Yesterday</div>
                <div class="kpi-comparisons" id="kpiRevenueComparisons"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Number of Invoices</span>
                    <span class="kpi-icon">üìÑ</span>
                </div>
                <div class="kpi-value" id="kpiInvoices">-</div>
                <div class="kpi-label">Yesterday</div>
                <div class="kpi-comparisons" id="kpiInvoicesComparisons"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Number of Transactions</span>
                    <span class="kpi-icon">üîÑ</span>
                </div>
                <div class="kpi-value" id="kpiTransactions">-</div>
                <div class="kpi-label">Yesterday</div>
                <div class="kpi-comparisons" id="kpiTransactionsComparisons"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Average Invoice Value</span>
                    <span class="kpi-icon">üìä</span>
                </div>
                <div class="kpi-value" id="kpiAvgInvoice">-</div>
                <div class="kpi-label">Yesterday</div>
                <div class="kpi-comparisons" id="kpiAvgInvoiceComparisons"></div>
            </div>
        </div>

            <!-- Staff Analytics Section -->
            <div style="margin-top: 48px;">
            <div class="header" style="margin-bottom: 32px; padding: 24px;">
                <div class="header-content">
                    <h1 style="font-size: 2rem; margin: 0;">üë• Staff Analytics</h1>
                    <p style="margin: 8px 0 0 0;">Staff performance and productivity insights</p>
                </div>
            </div>

            <!-- Staff KPI Cards -->
            <div class="kpi-grid" style="margin-bottom: 32px;">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Active Staff Members</span>
                        <span class="kpi-icon">üë§</span>
                    </div>
                <div class="kpi-value" id="staffActiveMembers">-</div>
                <div class="kpi-label">Current Month</div>
                    <div class="kpi-comparisons" id="staffActiveMembersComparisons"></div>
                </div>
            </div>
        </div>
        </div>

        <!-- Charts Page -->
        <div id="chartsPage" class="page">
            <!-- Financial Analytics Section -->
            <div class="section-container">
                <div class="section-header">
                    <h2 class="section-title">üí∞ Financial Analytics</h2>
                    <p class="section-subtitle">Revenue, invoices, and transaction insights</p>
                </div>

                <!-- Main Revenue & Invoices Trend Chart -->
                <div class="chart-card" style="margin-bottom: 32px;">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Revenue & Invoices Trend</h3>
                    </div>
                    <div class="chart-controls">
                        <div class="control-group">
                            <label class="control-label">View Period</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="viewPeriod" value="week" onchange="updateComparison()">
                                <span>This Week</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="viewPeriod" value="month" onchange="updateComparison()">
                                <span>This Month</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="viewPeriod" value="year" onchange="updateComparison()" checked>
                                <span>This Year</span>
                            </label>
                        </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Compare To</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="comparison" value="lastYear" onchange="updateComparison()">
                                <span>Last Year</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comparison" value="avgDay" onchange="updateComparison()">
                                <span>Average Day</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comparison" value="avgWeek" onchange="updateComparison()">
                                <span>Average Week</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comparison" value="avgMonth" onchange="updateComparison()">
                                <span>Average Month</span>
                            </label>
                        </div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="invoiceChart"></canvas>
                    </div>
                </div>

                <!-- Financial Analytics Grid -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>üìÖ Day of Week Analysis</h3>
                        <div class="analytics-chart">
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h3>üìÜ Monthly Trends</h3>
                        <div class="analytics-chart">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h3>üí∞ Revenue vs Invoices</h3>
                        <div class="analytics-chart">
                            <canvas id="revenueVsInvoicesChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h3>üìà Growth Rate</h3>
                        <div class="analytics-chart">
                            <canvas id="growthRateChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h3>üèÜ Top 10 Invoice Days</h3>
                        <div class="analytics-chart">
                            <canvas id="topDaysChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h3>üí≤ Avg Revenue per Invoice</h3>
                        <div class="analytics-chart">
                            <canvas id="avgRevenuePerInvoiceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Analytics Section -->
            <div class="section-container" style="margin-top: 48px;">
                <div class="section-header">
                    <h2 class="section-title">üë• Staff Analytics</h2>
                    <p class="section-subtitle">Staff performance, productivity, and efficiency metrics</p>
                </div>

                <!-- Staff Charts Grid -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>üèÜ Top Performing Staff</h3>
                        <div class="analytics-chart">
                            <canvas id="topStaffChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h3>üìà Staff Productivity Trend</h3>
                        <div class="analytics-chart">
                            <canvas id="staffProductivityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Page -->
        <div id="toolsPage" class="page">
            <div class="header" style="margin-bottom: 32px; padding: 24px;">
                <div class="header-content">
                    <h1 style="font-size: 2rem; margin: 0;">üõ†Ô∏è Tools</h1>
                    <p style="margin: 8px 0 0 0;">AI Query Assistant and Utilities</p>
                </div>
            </div>

            <!-- AI Query Assistant -->
            <div class="chart-card" style="max-width: 1200px; margin: 0 auto;">
                <div class="chart-header">
                    <h2 class="chart-title">ü§ñ AI Query Assistant</h2>
                </div>
                <div style="padding: 20px;">
                    <div id="aiChat" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px; min-height: 400px; max-height: 600px; overflow-y: auto;">
                        <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            <p>üí¨ Ask questions about your data</p>
                            <p style="font-size: 0.9rem; margin-top: 8px;">The AI will analyze your invoice and staff data to provide insights</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <input 
                            type="text" 
                            id="aiQueryInput" 
                            placeholder="Ask a question about your data..." 
                            style="flex: 1; padding: 12px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;"
                            onkeypress="if(event.key === 'Enter') sendQuery()"
                        >
                        <button 
                            class="btn btn-primary" 
                            onclick="sendQuery()"
                            style="padding: 12px 24px;"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay" onclick="if(event.target === this) closeSettings()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="form-group">
                <label class="form-label">Auto-Refresh Interval (seconds)</label>
                <input type="number" id="refreshInterval" class="form-input" min="10" max="3600" value="30">
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="autoRefreshEnabled" checked style="margin-right: 8px;">
                    Enable Auto-Refresh
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">Invoice Data Webhook</label>
                <input type="text" id="invoiceWebhookUrl" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Staff Data Webhook</label>
                <input type="text" id="staffWebhookUrl" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">AI Query Webhook</label>
                <input type="text" id="aiWebhookUrl" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Default Period View</label>
                <select id="defaultPeriod" class="form-input">
                    <option value="week">Last Week</option>
                    <option value="month">Last Month</option>
                    <option value="year" selected>Last Year</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-primary" onclick="saveSettings()" style="flex: 1;">üíæ Save Settings</button>
                <button class="btn" onclick="closeSettings()" style="flex: 1; background: var(--bg-secondary); color: var(--text-primary);">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Webhook Configuration
        const INVOICE_WEBHOOK = 'https://jackwilde.app.n8n.cloud/webhook/60e42850-6593-4d18-a4c7-c38293d1d768';
        const STAFF_WEBHOOK = 'https://jackwilde.app.n8n.cloud/webhook/15ae819e-7e5b-4db7-bcc0-2094eda868ff';
        const AI_WEBHOOK = 'https://jackwilde.app.n8n.cloud/webhook/dfd8f0c4-c739-4c8b-a772-48c2040cfc83';
        const CORS_PROXY = 'https://corsproxy.io/?';
        
        const isFileProtocol = window.location.protocol === 'file:';
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isGitHubPages = window.location.hostname.includes('github.io');
        
        const invoiceDataWebhookUrl = (isFileProtocol || isGitHubPages)
            ? (isGitHubPages ? CORS_PROXY + encodeURIComponent(INVOICE_WEBHOOK) : INVOICE_WEBHOOK)
            : '/proxy/invoice';
        const staffDataWebhookUrl = (isFileProtocol || isGitHubPages)
            ? (isGitHubPages ? CORS_PROXY + encodeURIComponent(STAFF_WEBHOOK) : STAFF_WEBHOOK)
            : '/proxy/staff';
        const aiWebhookUrl = (isFileProtocol || isGitHubPages)
            ? (isGitHubPages ? CORS_PROXY + encodeURIComponent(AI_WEBHOOK) : AI_WEBHOOK)
            : '/proxy/ai';

        // Global State
        let refreshIntervalId = null;
        let invoiceChart = null;
        let fullInvoiceData = null;
        let currentPeriod = 'year';
        let selectedComparisons = [];
        let dayOfWeekChart = null;
        let monthlyChart = null;
        let revenueVsInvoicesChart = null;
        let growthRateChart = null;
        let topDaysChart = null;
        let avgRevenuePerInvoiceChart = null;
        let staffData = null;
        let topStaffChart = null;
        let staffProductivityChart = null;

        // Navigation Functions
        function showPage(pageId, buttonElement) {
            console.log('showPage called with:', pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected page
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.classList.add('active');
                console.log('Showing page:', pageId + 'Page');
            } else {
                console.error('Page not found:', pageId + 'Page');
            }
            
            // Add active class to clicked tab
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // If showing charts page, ensure charts are rendered
            if (pageId === 'charts' && fullInvoiceData) {
                setTimeout(() => {
                    updateDisplayForPeriod(currentPeriod);
                    if (staffData && staffData.dailyData && staffData.dailyData.length > 0) {
                        updateStaffCharts();
                    }
                }, 100);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded - Initializing dashboard...');
            setupAutoRefresh();
            console.log('üìä Fetching invoice data from:', INVOICE_WEBHOOK);
            fetchData(); // Fetch invoice/financial data
            console.log('üë• Fetching staff data from:', STAFF_WEBHOOK);
            fetchStaffData(); // Fetch staff data
            loadSettings();
        });

        // Settings Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('invoiceWebhookUrl').value = INVOICE_WEBHOOK;
            document.getElementById('staffWebhookUrl').value = STAFF_WEBHOOK;
            document.getElementById('aiWebhookUrl').value = AI_WEBHOOK;
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            const interval = parseInt(document.getElementById('refreshInterval').value) || 30;
            const enabled = document.getElementById('autoRefreshEnabled').checked;
            const period = document.getElementById('defaultPeriod').value;
            
            localStorage.setItem('refreshInterval', interval);
            localStorage.setItem('autoRefreshEnabled', enabled);
            localStorage.setItem('defaultPeriod', period);
            
            setupAutoRefresh();
            currentPeriod = period;
            closeSettings();
        }

        function loadSettings() {
            const interval = localStorage.getItem('refreshInterval') || '30';
            const enabled = localStorage.getItem('autoRefreshEnabled') !== 'false';
            const period = localStorage.getItem('defaultPeriod') || 'year';
            
            document.getElementById('refreshInterval').value = interval;
            document.getElementById('autoRefreshEnabled').checked = enabled;
            document.getElementById('defaultPeriod').value = period;
            currentPeriod = period;
        }

        function setupAutoRefresh() {
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            const intervalSeconds = parseInt(localStorage.getItem('refreshInterval') || '30', 10);
            const autoRefreshEnabled = localStorage.getItem('autoRefreshEnabled') !== 'false';
            
            if (autoRefreshEnabled && intervalSeconds >= 10) {
                refreshIntervalId = setInterval(fetchData, intervalSeconds * 1000);
            }
        }

        // Connection Status
        function updateConnectionStatus(connected, status = 'connected') {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            if (statusEl) {
                statusEl.classList.toggle('error', !connected);
            }
            if (textEl) {
                textEl.textContent = connected ? (status === 'connecting' ? 'Connecting...' : 'Connected') : 'Disconnected';
            }
        }

        // Fetch Data from Webhook
        async function fetchData() {
            console.log('=== FETCH DATA START ===');
            console.log('Webhook URL:', invoiceDataWebhookUrl);
            updateConnectionStatus(true, 'connecting');
            
            try {
                const response = await fetch(invoiceDataWebhookUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('=== DATA RECEIVED FROM WEBHOOK ===');
                console.log('Data type:', typeof data);
                console.log('Is array:', Array.isArray(data));
                console.log('Data length:', Array.isArray(data) ? data.length : 'N/A');
                console.log('Full data:', data);
                
                if (Array.isArray(data) && data.length > 0) {
                    console.log('First item keys:', Object.keys(data[0]));
                    console.log('First item sample:', data[0]);
                    console.log('Sample of first 3 items:', data.slice(0, 3));
                    
                    // Check for staff data indicators
                    const hasStaffFields = data.some(item => 
                        item.staffid || item.staff_name || item.month_start || item.firstname || item.lastname
                    );
                    console.log('Has staff-related fields:', hasStaffFields);
                    
                    if (hasStaffFields) {
                        const staffItems = data.filter(item => 
                            item.staffid || item.staff_name || item.month_start
                        );
                        console.log('Number of items with staff fields:', staffItems.length);
                        if (staffItems.length > 0) {
                            console.log('Sample staff item:', staffItems[0]);
                        }
                    }
                }
                
                displayData(data);
                updateConnectionStatus(true, 'connected');
            } catch (error) {
                console.error('=== ERROR FETCHING DATA ===');
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                updateConnectionStatus(false);
            }
            console.log('=== FETCH DATA END ===');
        }

        // Fetch Staff Data from Webhook
        async function fetchStaffData() {
            console.log('=== FETCH STAFF DATA START ===');
            console.log('Staff Webhook URL:', staffDataWebhookUrl);
            
            try {
                const response = await fetch(staffDataWebhookUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('=== STAFF DATA RECEIVED FROM WEBHOOK ===');
                console.log('Staff data type:', typeof data);
                console.log('Staff data is array:', Array.isArray(data));
                console.log('Staff data length:', Array.isArray(data) ? data.length : 'N/A');
                console.log('Full staff data:', data);
                
                if (Array.isArray(data) && data.length > 0) {
                    console.log('First staff item keys:', Object.keys(data[0]));
                    console.log('First staff item sample:', data[0]);
                    console.log('Sample of first 3 staff items:', data.slice(0, 3));
                }
                
                // Process staff data
                console.log('Calling processStaffData with staff webhook data...');
                processStaffData(data);
                console.log('processStaffData completed. staffData:', staffData);
                
                // Update staff KPIs and charts
                if (staffData && staffData.dailyData && staffData.dailyData.length > 0) {
                    console.log('‚úÖ Staff data available! Updating staff KPIs and charts...');
                    console.log('Staff data summary:', {
                        dailyDataCount: staffData.dailyData.length,
                        totalStaff: staffData.totalStaff,
                        staffMembers: staffData.staffMembers
                    });
                    updateStaffKPICards(data);
                    updateStaffCharts();
                    console.log('‚úÖ Staff KPIs and charts updated successfully');
                } else {
                    console.warn('‚ùå No staff data processed from staff webhook');
                    console.warn('staffData:', staffData);
                    console.warn('staffData.dailyData:', staffData?.dailyData);
                    console.warn('staffData.dailyData.length:', staffData?.dailyData?.length);
                }
            } catch (error) {
                console.error('=== ERROR FETCHING STAFF DATA ===');
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Staff webhook URL that failed:', staffDataWebhookUrl);
                console.error('This error prevents staff data from loading. Please check:');
                console.error('1. Is the staff webhook URL correct?');
                console.error('2. Is the webhook accessible?');
                console.error('3. Is CORS configured correctly?');
            }
            console.log('=== FETCH STAFF DATA END ===');
        }

        // AI Query Assistant
        async function sendQuery() {
            const queryInput = document.getElementById('aiQueryInput');
            const chatContainer = document.getElementById('aiChat');
            
            if (!queryInput || !chatContainer) {
                console.error('AI chat elements not found');
                return;
            }

            const query = queryInput.value.trim();
            if (!query) {
                return;
            }

            // Add user message to chat
            addChatMessage('user', query);
            queryInput.value = '';

            // Show loading message
            const loadingId = addChatMessage('assistant', 'Thinking...', true);

            try {
                // Prepare data to send
                const requestData = {
                    query: query,
                    timestamp: new Date().toISOString(),
                    invoiceData: fullInvoiceData,
                    staffData: staffData
                };

                console.log('=== SENDING AI QUERY ===');
                console.log('Webhook URL:', aiWebhookUrl);
                console.log('Query:', query);
                console.log('Request data:', requestData);

                const response = await fetch(aiWebhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('=== AI RESPONSE RECEIVED ===');
                console.log('AI response:', data);

                // Remove loading message
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.remove();
                }

                // Add AI response
                const responseText = data.response || data.message || data.text || JSON.stringify(data);
                addChatMessage('assistant', responseText);

            } catch (error) {
                console.error('Error sending query:', error);
                
                // Remove loading message
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.remove();
                }

                // Add error message
                addChatMessage('assistant', `Error: ${error.message}. Please try again.`);
            }
        }

        function addChatMessage(role, message, isLoading = false) {
            const chatContainer = document.getElementById('aiChat');
            if (!chatContainer) return null;

            // Remove welcome message if it exists
            const welcomeMsg = chatContainer.querySelector('div[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const messageEl = document.createElement('div');
            messageEl.id = messageId;
            messageEl.style.cssText = `
                margin-bottom: 16px;
                padding: 12px 16px;
                border-radius: 12px;
                max-width: 80%;
                ${role === 'user' 
                    ? 'background: var(--primary); color: white; margin-left: auto; text-align: right;' 
                    : 'background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);'
                }
            `;

            if (isLoading) {
                messageEl.innerHTML = '<span style="opacity: 0.7;">‚è≥ ' + message + '</span>';
            } else {
                messageEl.textContent = message;
            }

            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageId;
        }

        // Process and Display Data
        function displayData(data) {
            console.log('=== DISPLAY DATA START ===');
            console.log('Input data type:', typeof data);
            console.log('Input is array:', Array.isArray(data));
            console.log('Input data length:', Array.isArray(data) ? data.length : 'N/A');
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.warn('=== NO DATA AVAILABLE ===');
                console.warn('Data:', data);
                return;
            }

            try {
                console.log('Processing invoice data...');
                const invoiceData = processInvoiceData(data);
                fullInvoiceData = invoiceData;
                console.log('Invoice data processed, updating KPI cards...');
                updateKPICards(data);
                console.log('Updating display for period:', currentPeriod);
                updateDisplayForPeriod(currentPeriod);
                
                // Note: Staff data is now fetched separately via fetchStaffData()
                // Only process staff data from invoice webhook if staff webhook hasn't loaded yet
                if (!staffData || !staffData.dailyData || staffData.dailyData.length === 0) {
                    console.log('No staff data from staff webhook yet, trying to extract from invoice data...');
                    console.log('=== PROCESSING STAFF DATA FROM INVOICE WEBHOOK ===');
                    processStaffData(data);
                    if (staffData && staffData.dailyData && staffData.dailyData.length > 0) {
                        console.log('Staff data extracted from invoice webhook, updating KPIs and charts...');
                        updateStaffKPICards(data);
                        updateStaffCharts();
                    }
                } else {
                    console.log('Staff data already loaded from staff webhook, skipping extraction from invoice data');
                }
            } catch (error) {
                console.error('=== ERROR IN DISPLAY DATA ===');
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
            }
            console.log('=== DISPLAY DATA END ===');
        }

        // Process Staff Data
        function processStaffData(data) {
            console.log('=== PROCESS STAFF DATA START ===');
            
            if (!data || !Array.isArray(data)) {
                console.error('processStaffData: No data or not an array');
                console.error('Data received:', data);
                return;
            }

            console.log('processStaffData: Processing', data.length, 'items');
            
            // Analyze data structure
            if (data.length > 0) {
                console.log('processStaffData: First item:', JSON.stringify(data[0], null, 2));
                console.log('processStaffData: First item keys:', Object.keys(data[0]));
                
                // Check for various possible staff data fields
                const firstItem = data[0];
                console.log('processStaffData: Checking for staff fields in first item:');
                console.log('  - staffid:', firstItem.staffid);
                console.log('  - staff_name:', firstItem.staff_name);
                console.log('  - month_start:', firstItem.month_start);
                console.log('  - firstname:', firstItem.firstname);
                console.log('  - lastname:', firstItem.lastname);
                console.log('  - invoices_touched:', firstItem.invoices_touched);
                console.log('  - txn_day:', firstItem.txn_day); // Invoice data field
            }

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);
            const endDate = yesterday;

            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 364);

            // Check if data contains staff information (has staffid or staff_name)
            const hasStaffData = data.some(item => item.staffid || item.staff_name || item.month_start);
            
            console.log('processStaffData: Has staff data?', hasStaffData);
            
            if (!hasStaffData) {
                console.warn('=== NO STAFF DATA DETECTED ===');
                console.warn('Checking all items for staff fields...');
                
                // Check each item for staff fields
                const itemsWithStaffFields = data.map((item, index) => {
                    const hasStaff = !!(item.staffid || item.staff_name || item.month_start || item.firstname || item.lastname);
                    return { index, hasStaff, keys: Object.keys(item) };
                }).filter(item => item.hasStaff);
                
                console.warn('Items with potential staff fields:', itemsWithStaffFields.length);
                if (itemsWithStaffFields.length > 0) {
                    console.warn('First item with staff fields:', itemsWithStaffFields[0]);
                    console.warn('Sample data item:', data[itemsWithStaffFields[0].index]);
                } else {
                    console.warn('No items found with staff fields. Sample keys from first item:', data[0] ? Object.keys(data[0]) : 'no data');
                }
                return;
            }

            // Group staff data by date (month_start)
            const staffByDate = {};
            const staffMembers = new Set();
            let processedCount = 0;
            let skippedCount = 0;
            const skippedItems = [];

            console.log('processStaffData: Starting to process items...');
            
            data.forEach((item, index) => {
                // Check if this is a staff record (has month_start and staff identifier)
                const hasMonthStart = !!item.month_start;
                const hasStaffId = !!(item.staffid || item.staff_name || item.firstname || item.lastname);
                
                if (hasMonthStart && hasStaffId) {
                    const dateStr = item.month_start;
                    const date = new Date(dateStr + 'T00:00:00');
                    
                    if (isNaN(date.getTime())) {
                        console.warn(`processStaffData: Invalid date for item ${index}:`, dateStr);
                        skippedCount++;
                        skippedItems.push({ index, reason: 'Invalid date', item });
                        return;
                    }
                    
                    // Don't filter by date range - include all staff data
                    if (!staffByDate[dateStr]) {
                        staffByDate[dateStr] = {
                            date: date,
                            staff: [],
                            totalInvoices: 0,
                            totalLines: 0,
                            totalRevenue: 0,
                            staffCount: 0
                        };
                    }

                    const staffMember = {
                        staffid: item.staffid || '',
                        staff_name: item.staff_name || `${item.firstname || ''} ${item.lastname || ''}`.trim(),
                        invoices_touched: item.invoices_touched || 0,
                        lines: item.lines || 0,
                        revenue: item.revenue || 0,
                        avg_revenue_per_line: item.avg_revenue_per_line || 0
                    };

                    staffByDate[dateStr].staff.push(staffMember);
                    staffByDate[dateStr].totalInvoices += staffMember.invoices_touched;
                    staffByDate[dateStr].totalLines += staffMember.lines;
                    staffByDate[dateStr].totalRevenue += staffMember.revenue;
                    staffByDate[dateStr].staffCount = staffByDate[dateStr].staff.length;
                    
                    staffMembers.add(staffMember.staffid || staffMember.staff_name);
                    processedCount++;
                    
                    if (processedCount <= 3) {
                        console.log(`processStaffData: Processed item ${index}:`, {
                            month_start: dateStr,
                            staff_name: staffMember.staff_name,
                            invoices: staffMember.invoices_touched,
                            revenue: staffMember.revenue
                        });
                    }
                } else {
                    skippedCount++;
                    if (skippedCount <= 5) {
                        skippedItems.push({ 
                            index, 
                            reason: hasMonthStart ? 'No staff identifier' : 'No month_start',
                            hasMonthStart,
                            hasStaffId,
                            itemKeys: Object.keys(item)
                        });
                    }
                }
            });

            console.log('processStaffData: Processed', processedCount, 'staff records');
            console.log('processStaffData: Skipped', skippedCount, 'records');
            if (skippedItems.length > 0) {
                console.log('processStaffData: Sample skipped items:', skippedItems.slice(0, 3));
            }
            console.log('processStaffData: Found', Object.keys(staffByDate).length, 'unique months');
            if (Object.keys(staffByDate).length > 0) {
                console.log('processStaffData: Month keys:', Object.keys(staffByDate).sort());
                console.log('processStaffData: Sample month data:', staffByDate[Object.keys(staffByDate)[0]]);
            }
            console.log('processStaffData: Staff members found:', Array.from(staffMembers));

            // Convert to daily array format
            const staffDailyData = Object.values(staffByDate).map(dayData => {
                const avgHours = dayData.staffCount > 0 ? 8 : 0; // Assume 8 hours per staff member
                const totalHours = dayData.staffCount * avgHours;
                const productivity = totalHours > 0 ? dayData.totalRevenue / totalHours : 0;
                
                return {
                    date: dayData.date,
                    staffCount: dayData.staffCount,
                    totalHours: totalHours,
                    avgHours: avgHours,
                    totalInvoices: dayData.totalInvoices,
                    totalLines: dayData.totalLines,
                    totalRevenue: dayData.totalRevenue,
                    productivity: productivity,
                    staff: dayData.staff
                };
            }).sort((a, b) => a.date - b.date);

            staffData = {
                dailyData: staffDailyData,
                staffMembers: Array.from(staffMembers),
                totalStaff: staffMembers.size,
                totalHours: staffDailyData.reduce((sum, d) => sum + (d.totalHours || 0), 0),
                totalStaffDays: staffDailyData.reduce((sum, d) => sum + (d.staffCount || 0), 0),
                avgHoursPerStaff: staffDailyData.length > 0 
                    ? staffDailyData.reduce((sum, d) => sum + (d.avgHours || 0), 0) / staffDailyData.length 
                    : 0
            };

            console.log('=== PROCESSED STAFF DATA SUMMARY ===');
            console.log('staffData object:', staffData);
            console.log('Daily data count:', staffDailyData.length);
            console.log('Total staff members:', staffMembers.size);
            console.log('Total hours:', staffData.totalHours);
            if (staffDailyData.length > 0) {
                console.log('First staff data entry:', JSON.stringify(staffDailyData[0], null, 2));
                console.log('Last staff data entry:', JSON.stringify(staffDailyData[staffDailyData.length - 1], null, 2));
                console.log('All months:', staffDailyData.map(d => d.date.toISOString().split('T')[0].substring(0, 7)));
            } else {
                console.warn('WARNING: No staff daily data created!');
            }
            console.log('=== PROCESS STAFF DATA END ===');
        }

        // Update Staff KPI Cards
        function updateStaffKPICards(data) {
            console.log('=== UPDATE STAFF KPI CARDS START ===');
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.error('updateStaffKPICards: No input data');
                return;
            }
            
            if (!staffData) {
                console.error('updateStaffKPICards: staffData is null/undefined');
                return;
            }
            
            if (!staffData.dailyData) {
                console.error('updateStaffKPICards: staffData.dailyData is null/undefined');
                console.error('staffData keys:', Object.keys(staffData));
                return;
            }
            
            if (staffData.dailyData.length === 0) {
                console.warn('updateStaffKPICards: staffData.dailyData is empty array');
                console.warn('staffData:', JSON.stringify(staffData, null, 2));
                return;
            }
            
            console.log('updateStaffKPICards: Updating with', staffData.dailyData.length, 'months of data');
            console.log('updateStaffKPICards: Staff data sample:', staffData.dailyData.slice(0, 3));

            // Since data is monthly (month_start), get current month and previous month
            const today = new Date();
            const currentMonth = today.toISOString().split('T')[0].substring(0, 7); // YYYY-MM
            
            const prevMonth = new Date(today);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            const prevMonthStr = prevMonth.toISOString().split('T')[0].substring(0, 7);
            
            const lastYearMonth = new Date(today);
            lastYearMonth.setFullYear(lastYearMonth.getFullYear() - 1);
            const lastYearMonthStr = lastYearMonth.toISOString().split('T')[0].substring(0, 7);

            // Find data by month_start (since data is monthly)
            const currentMonthStaff = staffData.dailyData.find(d => {
                const dateStr = d.date.toISOString().split('T')[0].substring(0, 7);
                return dateStr === currentMonth;
            });
            const prevMonthStaff = staffData.dailyData.find(d => {
                const dateStr = d.date.toISOString().split('T')[0].substring(0, 7);
                return dateStr === prevMonthStr;
            });
            const lastYearMonthStaff = staffData.dailyData.find(d => {
                const dateStr = d.date.toISOString().split('T')[0].substring(0, 7);
                return dateStr === lastYearMonthStr;
            });

            // Get last 12 months of data for average
            const twelveMonthsAgo = new Date(today);
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
            const recent12Months = staffData.dailyData.filter(d => 
                d.date >= twelveMonthsAgo && d.date <= today
            );
            const avg12Months = recent12Months.length > 0 ? {
                totalHours: recent12Months.reduce((sum, d) => sum + (d.totalHours || 0), 0) / recent12Months.length,
                staffCount: recent12Months.reduce((sum, d) => sum + (d.staffCount || 0), 0) / recent12Months.length,
                avgHours: recent12Months.reduce((sum, d) => sum + (d.avgHours || 0), 0) / recent12Months.length,
                productivity: recent12Months.reduce((sum, d) => sum + (d.productivity || 0), 0) / recent12Months.length
            } : { totalHours: null, staffCount: null, avgHours: null, productivity: null };

            // Active Staff Members
            updateKPICard('staffActiveMembers', 'staffActiveMembersComparisons', {
                value: currentMonthStaff ? currentMonthStaff.staffCount : null,
                prevDay: prevMonthStaff ? prevMonthStaff.staffCount : null,
                lastWeek: lastYearMonthStaff ? lastYearMonthStaff.staffCount : null,
                avg30d: avg12Months.staffCount
            }, (val) => Math.round(val) + ' staff');
        }

        // Update Staff Charts
        function updateStaffCharts() {
            if (!staffData || !staffData.dailyData || staffData.dailyData.length === 0) return;

            updateTopStaffChart();
            updateStaffProductivityChart();
        }

        function updateTopStaffChart() {
            const ctx = document.getElementById('staffDayOfWeekChart');
            if (!ctx || !staffData) return;
            
            if (staffDayOfWeekChart) staffDayOfWeekChart.destroy();
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayData = new Array(7).fill(0).map(() => ({ hours: 0, count: 0 }));
            
            staffData.dailyData.forEach(item => {
                const day = item.date.getDay();
                dayData[day].hours += item.totalHours;
                dayData[day].count++;
            });
            
            const avgHours = dayData.map(d => d.count > 0 ? d.hours / d.count : 0);
            
            staffDayOfWeekChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: 'Avg Hours',
                        data: avgHours,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateTopStaffChart() {
            const ctx = document.getElementById('topStaffChart');
            if (!ctx || !staffData) return;
            
            if (topStaffChart) topStaffChart.destroy();
            
            // Aggregate staff performance across all dates
            const staffPerformance = {};
            
            staffData.dailyData.forEach(dayData => {
                if (dayData.staff && Array.isArray(dayData.staff)) {
                    dayData.staff.forEach(staff => {
                        const staffKey = staff.staffid || staff.staff_name;
                        if (!staffPerformance[staffKey]) {
                            staffPerformance[staffKey] = {
                                name: staff.staff_name,
                                totalInvoices: 0,
                                totalRevenue: 0,
                                totalLines: 0,
                                count: 0
                            };
                        }
                        staffPerformance[staffKey].totalInvoices += staff.invoices_touched || 0;
                        staffPerformance[staffKey].totalRevenue += staff.revenue || 0;
                        staffPerformance[staffKey].totalLines += staff.lines || 0;
                        staffPerformance[staffKey].count++;
                    });
                }
            });
            
            // Calculate average revenue per staff member
            const staffList = Object.values(staffPerformance).map(staff => ({
                name: staff.name,
                avgRevenue: staff.count > 0 ? staff.totalRevenue / staff.count : 0,
                totalInvoices: staff.totalInvoices,
                totalRevenue: staff.totalRevenue
            }));
            
            const sorted = [...staffList].sort((a, b) => b.avgRevenue - a.avgRevenue).slice(0, 10);
            
            topStaffChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(item => item.name),
                    datasets: [{
                        label: 'Avg Revenue',
                        data: sorted.map(item => item.avgRevenue),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9',
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const staff = sorted[index];
                                    return [
                                        'Avg Revenue: $' + context.parsed.x.toFixed(2),
                                        'Total Revenue: $' + staff.totalRevenue.toLocaleString(),
                                        'Invoices: ' + staff.totalInvoices
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateStaffProductivityChart() {
            const ctx = document.getElementById('staffProductivityChart');
            if (!ctx || !staffData) return;
            
            if (staffProductivityChart) staffProductivityChart.destroy();
            
            const recentData = staffData.dailyData.slice(-12); // Last 12 months
            const productivity = recentData.map(d => 
                d.totalHours > 0 ? d.totalRevenue / d.totalHours : 0
            );
            
            staffProductivityChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: recentData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })),
                    datasets: [{
                        label: 'Productivity ($/hr)',
                        data: productivity,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9',
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2) + '/hr';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateStaffHoursDistributionChart() {
            const ctx = document.getElementById('staffHoursDistributionChart');
            if (!ctx || !staffData) return;
            
            if (staffHoursDistributionChart) staffHoursDistributionChart.destroy();
            
            const recentData = staffData.dailyData.slice(-30);
            const hoursRanges = {
                '0-4': 0,
                '4-6': 0,
                '6-8': 0,
                '8-10': 0,
                '10+': 0
            };
            
            recentData.forEach(d => {
                const hours = d.avgHours;
                if (hours < 4) hoursRanges['0-4']++;
                else if (hours < 6) hoursRanges['4-6']++;
                else if (hours < 8) hoursRanges['6-8']++;
                else if (hours < 10) hoursRanges['8-10']++;
                else hoursRanges['10+']++;
            });
            
            staffHoursDistributionChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(hoursRanges),
                    datasets: [{
                        data: Object.values(hoursRanges),
                        backgroundColor: [
                            '#6366f1',
                            '#8b5cf6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#f1f5f9' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9'
                        }
                    }
                }
            });
        }

        function updateStaffEfficiencyChart() {
            const ctx = document.getElementById('staffEfficiencyChart');
            if (!ctx || !staffData) return;
            
            if (staffEfficiencyChart) staffEfficiencyChart.destroy();
            
            const recentData = staffData.dailyData.slice(-12); // Last 12 months
            const efficiency = recentData.map(d => {
                // Efficiency = invoices per staff hour
                return d.totalHours > 0 ? (d.totalInvoices / d.totalHours) * 10 : 0;
            });
            
            staffEfficiencyChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: recentData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })),
                    datasets: [{
                        label: 'Efficiency (invoices per 10 staff hours)',
                        data: efficiency,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9',
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + ' invoices/10hrs';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function processInvoiceData(data) {
            if (!Array.isArray(data)) return null;

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);
            const endDate = yesterday;

            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 364);

            const dailyData = [];
            let totalInvoices = 0;
            let totalRevenue = 0;
            let weekdayDays = 0;
            let saturdayDays = 0;
            let weekdayInvoices = 0;
            let saturdayInvoices = 0;

            data.forEach(item => {
                if (item.txn_day && item.invoices !== undefined && item.revenue !== undefined) {
                    const date = new Date(item.txn_day + 'T00:00:00');
                    if (date <= endDate) {
                        const dayOfWeek = date.getDay();
                        const isSunday = dayOfWeek === 0;
                        const isSaturday = dayOfWeek === 6;
                        const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;

                        dailyData.push({
                            date: date,
                            count: item.invoices || 0,
                            revenue: item.revenue || 0
                        });

                        totalInvoices += (item.invoices || 0);
                        totalRevenue += (item.revenue || 0);

                        if (!isSunday) {
                            if (isWeekday) {
                                weekdayDays++;
                                weekdayInvoices += (item.invoices || 0);
                            } else if (isSaturday) {
                                saturdayDays++;
                                saturdayInvoices += (item.invoices || 0);
                            }
                        }
                    }
                }
            });

            const totalDays = dailyData.length;
            const avgPerDay = totalDays > 0 ? totalInvoices / totalDays : 0;
            const avgPerWeekday = weekdayDays > 0 ? weekdayInvoices / weekdayDays : 0;
            const avgPerSaturday = saturdayDays > 0 ? saturdayInvoices / saturdayDays : 0;

            return {
                totalInvoices,
                totalRevenue,
                avgPerDay,
                avgPerWeekday,
                avgPerSaturday,
                dailyData: dailyData.sort((a, b) => a.date - b.date)
            };
        }

        // KPI Cards Update
        function updateKPICards(data) {
            if (!data || !Array.isArray(data) || data.length === 0) return;

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            const dayBefore = new Date(yesterday);
            dayBefore.setDate(dayBefore.getDate() - 1);
            const dayBeforeStr = dayBefore.toISOString().split('T')[0];

            const lastWeek = new Date(yesterday);
            lastWeek.setDate(lastWeek.getDate() - 7);
            const lastWeekStr = lastWeek.toISOString().split('T')[0];

            // Find yesterday's data, or use the most recent data if yesterday's is not available
            let yesterdayData = data.find(d => d.txn_day === yesterdayStr);
            if (!yesterdayData) {
                // Sort data by date and get the most recent
                const sortedData = [...data].sort((a, b) => (b.txn_day || '').localeCompare(a.txn_day || ''));
                yesterdayData = sortedData[0];
            }
            
            const dayBeforeData = data.find(d => d.txn_day === dayBeforeStr);
            const lastWeekData = data.find(d => d.txn_day === lastWeekStr);

            const thirtyDaysAgo = new Date(yesterday);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const avg30Days = calculate30DayAverage(data, yesterdayStr, thirtyDaysAgo.toISOString().split('T')[0]);

            updateKPICard('kpiRevenue', 'kpiRevenueComparisons', {
                value: yesterdayData ? yesterdayData.revenue : null,
                prevDay: dayBeforeData ? dayBeforeData.revenue : null,
                lastWeek: lastWeekData ? lastWeekData.revenue : null,
                avg30d: avg30Days.revenue
            }, (val) => '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

            updateKPICard('kpiInvoices', 'kpiInvoicesComparisons', {
                value: yesterdayData ? yesterdayData.invoices : null,
                prevDay: dayBeforeData ? dayBeforeData.invoices : null,
                lastWeek: lastWeekData ? lastWeekData.invoices : null,
                avg30d: avg30Days.invoices
            }, (val) => val.toLocaleString());

            updateKPICard('kpiTransactions', 'kpiTransactionsComparisons', {
                value: yesterdayData ? yesterdayData.invoices : null,
                prevDay: dayBeforeData ? dayBeforeData.invoices : null,
                lastWeek: lastWeekData ? lastWeekData.invoices : null,
                avg30d: avg30Days.invoices
            }, (val) => val.toLocaleString());

            const avgInvoiceValue = yesterdayData && yesterdayData.invoices > 0 
                ? yesterdayData.revenue / yesterdayData.invoices 
                : null;
            const avgInvoicePrevDay = dayBeforeData && dayBeforeData.invoices > 0
                ? dayBeforeData.revenue / dayBeforeData.invoices
                : null;
            const avgInvoiceLastWeek = lastWeekData && lastWeekData.invoices > 0
                ? lastWeekData.revenue / lastWeekData.invoices
                : null;
            const avgInvoice30d = avg30Days.invoices > 0
                ? avg30Days.revenue / avg30Days.invoices
                : null;

            updateKPICard('kpiAvgInvoice', 'kpiAvgInvoiceComparisons', {
                value: avgInvoiceValue,
                prevDay: avgInvoicePrevDay,
                lastWeek: avgInvoiceLastWeek,
                avg30d: avgInvoice30d
            }, (val) => '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
        }

        function calculate30DayAverage(data, excludeDate, startDate) {
            const filtered = data.filter(d => {
                return d.txn_day >= startDate && d.txn_day < excludeDate;
            });

            if (filtered.length === 0) {
                return { revenue: null, invoices: null };
            }

            const totalRevenue = filtered.reduce((sum, d) => sum + (d.revenue || 0), 0);
            const totalInvoices = filtered.reduce((sum, d) => sum + (d.invoices || 0), 0);

            return {
                revenue: totalRevenue / filtered.length,
                invoices: totalInvoices / filtered.length
            };
        }

        function updateKPICard(valueId, comparisonsId, data, formatter) {
            const valueEl = document.getElementById(valueId);
            const comparisonsEl = document.getElementById(comparisonsId);

            if (!valueEl || !comparisonsEl) return;

            if (data.value !== null && data.value !== undefined) {
                valueEl.textContent = formatter(data.value);
            } else {
                valueEl.textContent = '‚Äî';
            }

            const comparisons = [];

            if (data.prevDay !== null && data.prevDay !== undefined && data.value !== null) {
                const change = calculatePercentageChange(data.prevDay, data.value);
                comparisons.push({ label: 'vs Day Before', value: change });
            } else {
                comparisons.push({ label: 'vs Day Before', value: null });
            }

            if (data.lastWeek !== null && data.lastWeek !== undefined && data.value !== null) {
                const change = calculatePercentageChange(data.lastWeek, data.value);
                comparisons.push({ label: 'vs Last Week', value: change });
            } else {
                comparisons.push({ label: 'vs Last Week', value: null });
            }

            if (data.avg30d !== null && data.avg30d !== undefined && data.value !== null) {
                const change = calculatePercentageChange(data.avg30d, data.value);
                // For staff analytics, show "vs 12-Month Avg" instead of "vs 30-Day Avg"
                const isStaffCard = valueId.startsWith('staff');
                const label = isStaffCard ? 'vs 12-Month Avg' : 'vs 30-Day Avg';
                comparisons.push({ label: label, value: change });
            } else {
                const isStaffCard = valueId.startsWith('staff');
                const label = isStaffCard ? 'vs 12-Month Avg' : 'vs 30-Day Avg';
                comparisons.push({ label: label, value: null });
            }

            comparisonsEl.innerHTML = comparisons.map(comp => {
                if (comp.value === null) {
                    return `
                        <div class="comparison-item">
                            <span class="comparison-label">${comp.label}</span>
                            <span class="comparison-value neutral">‚Äî</span>
                        </div>
                    `;
                }

                const absValue = Math.abs(comp.value);
                let className = 'neutral';
                let arrow = '‚Üí';
                
                if (absValue >= 1) {
                    className = comp.value > 0 ? 'positive' : 'negative';
                    arrow = comp.value > 0 ? '‚Üë' : '‚Üì';
                }

                return `
                    <div class="comparison-item">
                        <span class="comparison-label">${comp.label}</span>
                        <span class="comparison-value ${className}">
                            <span>${arrow}</span>
                            ${absValue.toFixed(1)}%
                        </span>
                    </div>
                `;
            }).join('');
        }

        function calculatePercentageChange(oldValue, newValue) {
            if (!oldValue || oldValue === 0) return null;
            return ((newValue - oldValue) / oldValue) * 100;
        }

        // Chart Updates
        function updateDisplayForPeriod(period) {
            if (!fullInvoiceData) return;
            currentPeriod = period;
            updateComparison();
        }

        function updateComparison() {
            if (!fullInvoiceData) return;

            const period = document.querySelector('input[name="viewPeriod"]:checked')?.value || 'year';
            const comparisons = Array.from(document.querySelectorAll('input[name="comparison"]:checked')).map(cb => cb.value);
            
            currentPeriod = period;
            selectedComparisons = comparisons;
            updateDisplayForPeriodWithComparisons(period, comparisons);
        }

        function updateDisplayForPeriodWithComparisons(period, comparisons) {
            if (!fullInvoiceData) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            let startDate, endDate;
            endDate = yesterday;

            switch(period) {
                case 'week':
                    startDate = new Date(yesterday);
                    startDate.setDate(startDate.getDate() - 6);
                    break;
                case 'month':
                    startDate = new Date(yesterday);
                    startDate.setDate(startDate.getDate() - 29);
                    break;
                case 'year':
                default:
                    startDate = new Date(yesterday);
                    startDate.setDate(startDate.getDate() - 364);
                    break;
            }

            const mainData = fullInvoiceData.dailyData.filter(item => {
                return item.date >= startDate && item.date <= endDate;
            });

            const comparisonDatasets = [];
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#14b8a6'];
            let colorIndex = 0;

            comparisons.forEach(comp => {
                let compData = [];
                switch(comp) {
                    case 'lastYear':
                        const lastYearStart = new Date(startDate);
                        lastYearStart.setFullYear(lastYearStart.getFullYear() - 1);
                        const lastYearEnd = new Date(endDate);
                        lastYearEnd.setFullYear(lastYearEnd.getFullYear() - 1);
                        compData = fullInvoiceData.dailyData.filter(d => 
                            d.date >= lastYearStart && d.date <= lastYearEnd
                        );
                        break;
                    case 'avgDay':
                        const allDays = fullInvoiceData.dailyData.filter(d => d.date <= endDate);
                        const avgDayInvoices = allDays.length > 0 
                            ? allDays.reduce((sum, item) => sum + (item.count || 0), 0) / allDays.length
                            : 0;
                        const avgDayRevenue = allDays.length > 0 
                            ? allDays.reduce((sum, item) => sum + (item.revenue || 0), 0) / allDays.length
                            : 0;
                        compData = mainData.map(item => ({
                            date: item.date,
                            count: avgDayInvoices,
                            revenue: avgDayRevenue
                        }));
                        break;
                    case 'avgWeek':
                        const allWeeks = [];
                        for (let i = 0; i < mainData.length; i += 7) {
                            const week = mainData.slice(i, i + 7);
                            if (week.length > 0) {
                                const weekInvoices = week.reduce((sum, item) => sum + (item.count || 0), 0) / week.length;
                                const weekRevenue = week.reduce((sum, item) => sum + (item.revenue || 0), 0) / week.length;
                                week.forEach(item => {
                                    allWeeks.push({
                                        date: item.date,
                                        count: weekInvoices,
                                        revenue: weekRevenue
                                    });
                                });
                            }
                        }
                        compData = allWeeks;
                        break;
                    case 'avgMonth':
                        const allMonths = [];
                        const monthGroups = {};
                        mainData.forEach(item => {
                            const monthKey = item.date.getFullYear() + '-' + item.date.getMonth();
                            if (!monthGroups[monthKey]) {
                                monthGroups[monthKey] = [];
                            }
                            monthGroups[monthKey].push(item);
                        });
                        Object.values(monthGroups).forEach(month => {
                            const monthInvoices = month.reduce((sum, item) => sum + (item.count || 0), 0) / month.length;
                            const monthRevenue = month.reduce((sum, item) => sum + (item.revenue || 0), 0) / month.length;
                            month.forEach(item => {
                                allMonths.push({
                                    date: item.date,
                                    count: monthInvoices,
                                    revenue: monthRevenue
                                });
                            });
                        });
                        compData = allMonths;
                        break;
                }

                if (compData.length > 0) {
                    comparisonDatasets.push({
                        label: comp.replace(/([A-Z])/g, ' $1').trim(),
                        data: compData.map(item => ({
                            x: item.date,
                            y: item.count
                        })),
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0.4
                    });
                    colorIndex++;
                }
            });

            updateChartWithComparisons(mainData, comparisonDatasets, period);
            updateDayOfWeekChart(mainData);
            updateMonthlyTrendsChart(mainData);
            updateRevenueVsInvoicesChart(mainData);
            updateGrowthRateChart(mainData);
            updateTopDaysChart(mainData);
            updateAvgRevenuePerInvoiceChart(mainData);
        }

        function updateChartWithComparisons(mainData, comparisonDatasets, period) {
            // Use provided period or fall back to currentPeriod or 'year'
            const chartPeriod = period || currentPeriod || 'year';
            const ctx = document.getElementById('invoiceChart').getContext('2d');
            
            if (invoiceChart) {
                invoiceChart.destroy();
            }

            const datasets = [
                {
                    label: 'Invoices',
                    data: mainData.map(item => ({
                        x: item.date,
                        y: item.count
                    })),
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Revenue',
                    data: mainData.map(item => ({
                        x: item.date,
                        y: item.revenue
                    })),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y1'
                },
                ...comparisonDatasets
            ];

            invoiceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#f1f5f9',
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: chartPeriod === 'year' ? 'month' : chartPeriod === 'month' ? 'day' : 'day'
                            },
                            grid: {
                                color: '#334155'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Invoices',
                                color: '#94a3b8'
                            },
                            grid: {
                                color: '#334155'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Revenue ($)',
                                color: '#94a3b8'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Analytics Chart Functions (simplified versions)
        function updateDayOfWeekChart(dailyData) {
            const ctx = document.getElementById('dayOfWeekChart');
            if (!ctx) return;
            
            if (dayOfWeekChart) dayOfWeekChart.destroy();
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayData = new Array(7).fill(0).map(() => ({ invoices: 0, count: 0 }));
            
            dailyData.forEach(item => {
                const day = item.date.getDay();
                dayData[day].invoices += item.count;
                dayData[day].count++;
            });
            
            const avgInvoices = dayData.map(d => d.count > 0 ? d.invoices / d.count : 0);
            
            dayOfWeekChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: 'Avg Invoices',
                        data: avgInvoices,
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateMonthlyTrendsChart(dailyData) {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            if (monthlyChart) monthlyChart.destroy();
            
            const monthData = {};
            dailyData.forEach(item => {
                const monthKey = item.date.getFullYear() + '-' + (item.date.getMonth() + 1);
                if (!monthData[monthKey]) {
                    monthData[monthKey] = { invoices: 0, revenue: 0, count: 0 };
                }
                monthData[monthKey].invoices += item.count;
                monthData[monthKey].revenue += item.revenue;
                monthData[monthKey].count++;
            });
            
            const labels = Object.keys(monthData).sort();
            const invoices = labels.map(key => monthData[key].invoices);
            
            monthlyChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Invoices',
                        data: invoices,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateRevenueVsInvoicesChart(dailyData) {
            const ctx = document.getElementById('revenueVsInvoicesChart');
            if (!ctx) return;
            
            if (revenueVsInvoicesChart) revenueVsInvoicesChart.destroy();
            
            revenueVsInvoicesChart = new Chart(ctx.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Revenue vs Invoices',
                        data: dailyData.map(item => ({
                            x: item.count,
                            y: item.revenue
                        })),
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Invoices', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            title: { display: true, text: 'Revenue ($)', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateGrowthRateChart(dailyData) {
            const ctx = document.getElementById('growthRateChart');
            if (!ctx) return;
            
            if (growthRateChart) growthRateChart.destroy();
            
            const growthRates = [];
            const labels = [];
            
            for (let i = 1; i < dailyData.length; i++) {
                const prev = dailyData[i - 1].count;
                const curr = dailyData[i].count;
                if (prev > 0) {
                    growthRates.push(((curr - prev) / prev) * 100);
                    labels.push(dailyData[i].date.toLocaleDateString());
                }
            }
            
            growthRateChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels.slice(-30),
                    datasets: [{
                        label: 'Growth Rate %',
                        data: growthRates.slice(-30),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9'
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateTopDaysChart(dailyData) {
            const ctx = document.getElementById('topDaysChart');
            if (!ctx) return;
            
            if (topDaysChart) topDaysChart.destroy();
            
            const sorted = [...dailyData].sort((a, b) => b.count - a.count).slice(0, 10);
            
            topDaysChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(item => item.date.toLocaleDateString()),
                    datasets: [{
                        label: 'Invoices',
                        data: sorted.map(item => item.count),
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateAvgRevenuePerInvoiceChart(dailyData) {
            const ctx = document.getElementById('avgRevenuePerInvoiceChart');
            if (!ctx) return;
            
            if (avgRevenuePerInvoiceChart) avgRevenuePerInvoiceChart.destroy();
            
            const avgRevenue = dailyData.map(item => 
                item.count > 0 ? item.revenue / item.count : 0
            );
            
            avgRevenuePerInvoiceChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: dailyData.map(item => item.date.toLocaleDateString()),
                    datasets: [{
                        label: 'Avg Revenue per Invoice',
                        data: avgRevenue,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9',
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>

